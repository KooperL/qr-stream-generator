<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .upload-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
        }
        input[type="file"] {
            margin: 20px 0;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
        #videoContainer {
            margin-top: 20px;
        }
        #videoContainer video {
            max-width: 100%;
        }
        #canvas {
            display: none;
        }
        .progress {
            margin-top: 20px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <h2>QR Code Video Scanner</h2>
        <form id="uploadForm">
            <input type="file" id="fileInput" name="file" accept="video/*">
            <div id="errorMessage" class="error-message">Please select a valid video file.</div>
        </form>
        <div id="videoContainer"></div>
        <div class="progress">
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <p id="progressText">Processing: 0%</p>
        </div>
    </div>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const QRScanner = {
            frames: [],
            headerFrame: null,
            isProcessing: false,

            async processVideo(videoFile) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoFile);
                videoContainer.innerHTML = '';
                videoContainer.appendChild(video);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 256;

                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        this.isProcessing = true;
                        this.showProgress();

                        const processFrame = async () => {
                            if (!this.isProcessing) return;

                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            try {
                                const code = jsQR(imageData.data, imageData.width, imageData.height);
                                if (code) {
                                    const frame = JSON.parse(code.data);
                                    if (frame.version === 1 && !this.headerFrame) {
                                        this.headerFrame = frame;
                                    } else if (frame.frameNumber) {
                                        this.frames[frame.frameNumber - 1] = frame;
                                    }
                                    this.updateProgress();
                                }
                            } catch (error) {
                                console.error('Error processing frame:', error);
                            }

                            if (video.currentTime < video.duration) {
                                requestAnimationFrame(processFrame);
                            } else {
                                this.isProcessing = false;
                                this.hideProgress();
                                resolve(this.reconstructFile());
                            }
                        };

                        processFrame();
                    };

                    video.onerror = () => {
                        reject(new Error('Error loading video'));
                    };
                });
            },

            async reconstructFile() {
                if (!this.headerFrame || this.frames.length === 0) {
                    throw new Error('No valid frames found');
                }

                const { filename, totalBytes } = this.headerFrame;
                const chunks = [];

                for (const frame of this.frames) {
                    if (frame && frame.data) {
                        const binaryString = atob(frame.data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        chunks.push(bytes);
                    }
                }

                const blob = new Blob(chunks, { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                URL.revokeObjectURL(url);
                return blob;
            },

            showProgress() {
                document.querySelector('.progress').style.display = 'block';
            },

            hideProgress() {
                document.querySelector('.progress').style.display = 'none';
            },

            updateProgress() {
                const progress = (this.frames.filter(f => f).length / this.headerFrame.totalFrames) * 100;
                document.querySelector('.progress-bar-fill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `Processing: ${Math.round(progress)}%`;
            }
        };

        // Main application code
        const fileInput = document.getElementById('fileInput');
        const errorMessage = document.getElementById('errorMessage');

        fileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            
            errorMessage.style.display = 'none';
            
            if (files.length > 1) {
                errorMessage.style.display = 'block';
                fileInput.value = '';
                return;
            }
            
            const file = files[0];
            if (file) {
                try {
                    await QRScanner.processVideo(file);
                } catch (error) {
                    console.error('Error processing video:', error);
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html> 